<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Business - Sistema Automatizado</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #000000;
            --primary-light: #333333;
            --secondary: #666666;
            --background: #ffffff;
            --background-light: #f5f5f5;
            --background-dark: #e0e0e0;
            --text: #000000;
            --text-secondary: #666666;
            --text-light: #999999;
            --white: #ffffff;
            --border: #e0e0e0;
            --accent: #1a1a1a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: var(--white);
            border-radius: 0;
            box-shadow: 0 0 60px rgba(0,0,0,0.08);
            max-width: 700px;
            width: 100%;
            padding: 50px;
            border: 1px solid var(--border);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            width: 120px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            border: 2px solid var(--primary);
        }
        .logo img{
            width: 100%;
        }

        h1 {
            color: var(--text);
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
        }

        /* Permissions Section */
        .permissions-section {
            background: var(--background-light);
            padding: 28px;
            border-radius: 0;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .section-title i {
            font-size: 24px;
            color: var(--primary);
        }

        .permission-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--white);
            border-radius: 0;
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
        }

        .permission-item.not-used {
            border-left-color: var(--secondary);
            opacity: 0.6;
        }

        .permission-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--background-light);
            border-radius: 0;
            border: 1px solid var(--border);
        }

        .permission-item.not-used .permission-icon {
            background: var(--background-dark);
            opacity: 0.5;
        }

        .permission-icon i {
            font-size: 20px;
            color: var(--primary);
        }

        .permission-item.not-used .permission-icon i {
            color: var(--secondary);
        }

        .permission-content {
            flex: 1;
        }

        .permission-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .permission-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Data Usage Section */
        .data-usage {
            background: var(--background-light);
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
            padding: 22px;
            border-radius: 0;
            margin-bottom: 25px;
        }

        .data-usage .section-title {
            color: var(--text);
            margin-bottom: 15px;
        }

        .data-usage .section-title i {
            color: var(--primary);
        }

        .data-usage p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .data-usage ul {
            list-style: none;
            padding-left: 0;
        }

        .data-usage li {
            font-size: 13px;
            color: var(--text-secondary);
            padding-left: 24px;
            position: relative;
            margin-bottom: 8px;
        }

        .data-usage li:before {
            content: "•";
            position: absolute;
            left: 8px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Privacy Commitment */
        .privacy-commitment {
            background: var(--background-light);
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
            padding: 22px;
            border-radius: 0;
            margin-bottom: 30px;
        }

        .privacy-commitment .section-title {
            color: var(--text);
            margin-bottom: 12px;
        }

        .privacy-commitment .section-title i {
            color: var(--primary);
        }

        .privacy-commitment p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Connect Button */
        .btn-connect {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-connect:hover {
            background: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-connect:active {
            transform: translateY(0);
        }

        .btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-connect i {
            font-size: 20px;
        }

        /* Status Box */
        .status-box {
            margin-top: 20px;
            padding: 16px;
            border-radius: 0;
            display: none;
            animation: slideIn 0.3s ease;
            border-left: 3px solid var(--primary);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-box.show {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .status-box i {
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .status-loading {
            background: var(--background-light);
            border-left: 3px solid var(--secondary);
            color: var(--text-secondary);
        }

        .status-success {
            background: var(--background-light);
            border-left: 3px solid var(--primary);
            color: var(--text);
        }

        .status-error {
            background: var(--background-light);
            border-left: 3px solid var(--primary);
            color: var(--text);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Profile Info */
        .profile-info {
            display: none;
            margin-top: 20px;
            padding: 25px;
            background: var(--background-light);
            border-radius: 0;
            border: 2px solid var(--border);
            text-align: center;
        }

        .profile-info.show {
            display: block;
        }

        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .footer p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 14px;
            }

            .section-title {
                font-size: 16px;
            }

            .permission-item {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
               <img src="https://www.teamcriativa.com/IMAGES/logo.jpg" alt="logo">
            </div>
            <h1>Conectar Instagram Business</h1>
            <p class="subtitle">
                Conecte sua conta Instagram Business de forma segura e transparente para gerenciar suas publicações.
            </p>
        </div>

        <!-- Permissões que USAMOS -->
        <div class="permissions-section">
            <div class="section-title">
                <i class="ph ph-check-circle"></i>
                <span>Permissões Necessárias</span>
            </div>
            <div class="permission-list">
                <div class="permission-item">
                    <div class="permission-icon">
                        <i class="ph ph-user-circle"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Informações Básicas do Perfil</div>
                        <div class="permission-desc">Nome de usuário e foto de perfil para identificação da conta</div>
                    </div>
                </div>
                <div class="permission-item">
                    <div class="permission-icon">
                        <i class="ph ph-image"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Visualizar Publicações</div>
                        <div class="permission-desc">Acesso às suas publicações já realizadas no Instagram</div>
                    </div>
                </div>
                <div class="permission-item">
                    <div class="permission-icon">
                        <i class="ph ph-upload"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Publicar Conteúdo</div>
                        <div class="permission-desc">Criar e agendar publicações (fotos, vídeos, carrosséis e stories)</div>
                    </div>
                </div>
                <div class="permission-item">
                    <div class="permission-icon">
                        <i class="ph ph-facebook-logo"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Página do Facebook</div>
                        <div class="permission-desc">Acesso à página conectada ao Instagram Business (requerido pela Meta)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permissões que NÃO USAMOS -->
        <div class="permissions-section">
            <div class="section-title">
                <i class="ph ph-x-circle"></i>
                <span>O Que NÃO Acessamos</span>
            </div>
            <div class="permission-list">
                <div class="permission-item not-used">
                    <div class="permission-icon">
                        <i class="ph ph-chat-circle"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Mensagens Diretas</div>
                        <div class="permission-desc">Não lemos, enviamos ou acessamos suas conversas privadas</div>
                    </div>
                </div>
                <div class="permission-item not-used">
                    <div class="permission-icon">
                        <i class="ph ph-chat-text"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Comentários</div>
                        <div class="permission-desc">Não acessamos, lemos ou respondemos comentários</div>
                    </div>
                </div>
                <div class="permission-item not-used">
                    <div class="permission-icon">
                        <i class="ph ph-eye"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Visualizações de Stories</div>
                        <div class="permission-desc">Não acessamos quem visualizou seus stories</div>
                    </div>
                </div>
                <div class="permission-item not-used">
                    <div class="permission-icon">
                        <i class="ph ph-users"></i>
                    </div>
                    <div class="permission-content">
                        <div class="permission-title">Lista de Seguidores</div>
                        <div class="permission-desc">Não acessamos sua lista de seguidores ou seguindo</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uso dos Dados -->
        <div class="data-usage">
            <div class="section-title">
                <i class="ph ph-shield-check"></i>
                <span>Como Usamos Seus Dados</span>
            </div>
            <p><strong>Nosso aplicativo utiliza apenas:</strong></p>
            <ul>
                <li>Nome de usuário e foto de perfil para identificação visual</li>
                <li>ID da conta Instagram Business para conexão técnica</li>
                <li>Token de acesso para publicação autorizada</li>
                <li>Metadados das publicações já existentes (data, tipo, mídia)</li>
            </ul>
        </div>

        <!-- Compromisso de Privacidade -->
        <div class="privacy-commitment">
            <div class="section-title">
                <i class="ph ph-lock"></i>
                <span>Nosso Compromisso</span>
            </div>
            <p>
                <strong>Garantimos que:</strong> Seus dados são armazenados de forma segura e criptografada. 
                Não compartilhamos suas informações com terceiros. 
                Você pode revogar o acesso a qualquer momento através das configurações do Instagram. 
                Cumprimos todas as diretrizes da Meta e LGPD.
            </p>
        </div>

        <button class="btn-connect" id="connectBtn" onclick="startAuth()">
            <i class="ph-fill ph-lock-key"></i>
            <span>Autorizar Conexão Segura</span>
        </button>

        <div class="status-box" id="statusBox"></div>

        <div class="profile-info" id="profileInfo">
            <img src="" alt="Profile" class="profile-photo" id="profilePhoto">
            <div class="profile-name" id="profileName"></div>
            <div class="profile-id" id="profileId"></div>
        </div>

        <div class="footer">
            <p>Sistema desenvolvido com segurança e transparência</p>
        </div>
    </div>

    <script>
        // Configurações
        const APP_ID = '2633543703653982';
        const APP_SECRET = 'dfdbd31e81bc378a8f84512ecf1f36dc';
        const REDIRECT_URI = 'https://callback.teamcriativa.com/';
        
        const SUPABASE_URL = 'https://owpboqevrtthsupugcrt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cGJvcWV2cnR0aHN1cHVnY3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjY4MDQsImV4cCI6MjA2OTUwMjgwNH0.7RjkVOUT6ByewP0D6FgHQjZDCoi4GYnGT6BMj794MfQ';

        // Verificar se veio do redirect
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                showStatus('error', 'Autorização cancelada pelo usuário.');
                return;
            }

            if (code) {
                window.history.replaceState({}, document.title, window.location.pathname);
                await processAuthorization(code);
            }
        };

        function startAuth() {
            const scopes = [
                'instagram_basic',
                'instagram_content_publish',
                'pages_show_list',
                'pages_read_engagement',
                'business_management'
            ].join(',');

            const authUrl = `https://www.facebook.com/v21.0/dialog/oauth?` +
                `client_id=${APP_ID}` +
                `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                `&scope=${encodeURIComponent(scopes)}` +
                `&response_type=code`;

            window.location.href = authUrl;
        }

        async function processAuthorization(code) {
            try {
                showStatus('loading', 'Processando autorização...');
                disableButton();

                showStatus('loading', 'Obtendo token de acesso...');
                const tokenUrl = `https://graph.facebook.com/v21.0/oauth/access_token?` +
                    `client_id=${APP_ID}` +
                    `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                    `&client_secret=${APP_SECRET}` +
                    `&code=${code}`;

                const tokenResponse = await fetch(tokenUrl);
                const tokenData = await tokenResponse.json();

                if (!tokenData.access_token) {
                    throw new Error(tokenData.error?.message || 'Erro ao obter token');
                }

                const userToken = tokenData.access_token;

                showStatus('loading', 'Buscando páginas do Facebook...');
                const pagesResponse = await fetch(
                    `https://graph.facebook.com/v21.0/me/accounts?access_token=${userToken}`
                );
                const pagesData = await pagesResponse.json();

                if (!pagesData.data || pagesData.data.length === 0) {
                    throw new Error('Nenhuma página do Facebook encontrada. Você precisa de uma página conectada a uma conta Instagram Business.');
                }

                const page = pagesData.data[0];
                const pageAccessToken = page.access_token;

                showStatus('loading', 'Buscando conta Instagram Business...');
                const igResponse = await fetch(
                    `https://graph.facebook.com/v21.0/${page.id}?fields=instagram_business_account&access_token=${pageAccessToken}`
                );
                const igData = await igResponse.json();

                if (!igData.instagram_business_account) {
                    throw new Error('Nenhuma conta Instagram Business conectada a esta página. Conecte uma conta no Facebook Business Suite.');
                }

                const igAccountId = igData.instagram_business_account.id;

                showStatus('loading', 'Obtendo informações do perfil...');
                const profileResponse = await fetch(
                    `https://graph.facebook.com/v21.0/${igAccountId}?fields=username,profile_picture_url&access_token=${pageAccessToken}`
                );
                const profileData = await profileResponse.json();

                showStatus('loading', 'Gerando token de longa duração...');
                const longTokenUrl = `https://graph.facebook.com/v21.0/oauth/access_token?` +
                    `grant_type=fb_exchange_token` +
                    `&client_id=${APP_ID}` +
                    `&client_secret=${APP_SECRET}` +
                    `&fb_exchange_token=${pageAccessToken}`;

                const longTokenResponse = await fetch(longTokenUrl);
                const longTokenData = await longTokenResponse.json();

                const finalToken = longTokenData.access_token || pageAccessToken;
                
                const validadeToken = new Date();
                validadeToken.setDate(validadeToken.getDate() + 60);

                showStatus('loading', 'Salvando dados no banco...');
                await saveToSupabase({
                    users: profileData.username,
                    profile_photo: profileData.profile_picture_url,
                    id_instagram: igAccountId,
                    access_token: finalToken,
                    validade_token: validadeToken.toISOString()
                });

                showStatus('success', 
                    `<strong>Conectado com sucesso!</strong><br><br>` +
                    `Conta: @${profileData.username}<br>` +
                    `Redirecionando...`
                );

                showProfile(profileData.username, profileData.profile_picture_url, igAccountId);
                
                // Redirecionar após 2 segundos
                setTimeout(() => {
                    window.location.href = 'https://portal.teamcriativa.com/';
                }, 2000);

                showProfile(profileData.username, profileData.profile_picture_url, igAccountId);
                enableButton();

            } catch (error) {
                showStatus('error', `<strong>Erro:</strong><br>${error.message}`);
                enableButton();
            }
        }

        async function saveToSupabase(data) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/client`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                if (response.status === 409) {
                    const updateResponse = await fetch(
                        `${SUPABASE_URL}/rest/v1/client?id_instagram=eq.${data.id_instagram}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(data)
                        }
                    );
                    
                    if (!updateResponse.ok) {
                        throw new Error('Erro ao atualizar dados no banco');
                    }
                } else {
                    throw new Error('Erro ao salvar no banco de dados');
                }
            }
        }

        function showStatus(type, message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box status-${type} show`;
            
            let icon = '';
            if (type === 'loading') {
                icon = '<span class="spinner"></span>';
            } else if (type === 'success') {
                icon = '<i class="ph-fill ph-check-circle"></i>';
            } else if (type === 'error') {
                icon = '<i class="ph-fill ph-x-circle"></i>';
            }
            
            statusBox.innerHTML = icon + '<div>' + message + '</div>';
        }

        function showProfile(username, photoUrl, igId) {
            document.getElementById('profilePhoto').src = photoUrl;
            document.getElementById('profileName').textContent = '@' + username;
            document.getElementById('profileId').textContent = 'ID: ' + igId;
            document.getElementById('profileInfo').classList.add('show');
        }

        function disableButton() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span><span>Processando...</span>';
        }

        function enableButton() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="ph-fill ph-lock-key"></i><span>Autorizar Conexão Segura</span>';
        }
    </script>
</body>
</html>




